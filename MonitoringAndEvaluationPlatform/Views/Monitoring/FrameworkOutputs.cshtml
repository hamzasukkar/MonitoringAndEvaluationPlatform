@using MonitoringAndEvaluationPlatform.Helpers;
@using Microsoft.AspNetCore.Razor.TagHelpers;
@model IEnumerable<MonitoringAndEvaluationPlatform.Models.Output>
@{
    ViewData["Title"] = "Monitoring";
    Layout = "~/Views/Shared/_ResultsFrameworkLayout.cshtml";
}

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Health Framework Dashboard</title>
	<link rel="stylesheet" href="~/css/progress-bars.css" />
</head>
<body>
	<div class="framework-container">
		@foreach (var item in Model)
		{
			var subOutputs = item.SubOutputs;
			var indicators = subOutputs.SelectMany(subOutput => subOutput.Indicators);
			var projectCount = indicators
			.SelectMany(indicator => indicator.Measures)
			.Select(measure => measure.Project)
			.Distinct()
			.Count();

			// Create metrics array for cleaner iteration
			var metrics = new[]
			{
		new { Value = Math.Round(item.IndicatorsPerformance, 2), Label = "Performance Assessment", Action = "" },
		new { Value = Math.Round(item.DisbursementPerformance, 2), Label = "Disbursement", Action = "" },
		new { Value = Math.Round(item.FieldMonitoring, 2), Label = "Monitoring", Action = "" },
		new { Value = Math.Round(item.ImpactAssessment, 2), Label = "Assessment", Action = "" }
		};

			<div class="framework-card">
				<div class="framework-header">
					<h2>@item.Name</h2>
					<div class="outcome-badge">SubOutputs: @subOutputs.Count()</div>
				</div>

				@foreach (var metric in metrics)
				{
					var progressClass = ProgressHelper.GetProgressClass(metric.Value);
					<div class="metric">
						<div class="metric-value @progressClass.Split(' ')[1]">@metric.Value%</div>
						<div class="metric-label">@metric.Label</div>
						<div class="progress-container">
							<div class="progress-bar @progressClass.Split(' ')[0]" style="width: @metric.Value%"></div>
						</div>
					</div>
				}

				<div class="outcome-stats">
					<div class="stat-grid">
						<div class="stat-item">
							<a asp-controller="Monitoring" asp-action="OutputSubOutputs" asp-route-id="@item.Code">
								<div class="stat-value">@subOutputs.Count()</div>
								<div class="stat-label">Sub-outputs</div>
							</a>
						</div>
						<div class="stat-item">
							<a asp-controller="Monitoring" asp-action="Indicators" asp-route-outputCode="@item.Code">
								<div class="stat-value">@indicators.Count()</div>
								<div class="stat-label">Indicators</div>
							</a>
						</div>
						<div class="stat-item">
							<a asp-controller="Monitoring" asp-action="FrameworkProjects" asp-route-id="@item.Code">
								<div class="stat-value">@projectCount</div>
								<div class="stat-label">Projects</div>
							</a>
						</div>
					</div>
				</div>
			</div>
		}
	</div>
</body>
</html>
